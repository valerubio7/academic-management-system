{% extends 'base.html' %}{% extends 'base.html' %}

{% block title %}{{ action }} Usuario{% endblock %}{% block title %}Usuario{% endblock %}

{% block content %}{% block content %}

<h1>{{ action }} Usuario</h1><h1>Usuario</h1>

<form method="post"><form method="post">

  {% csrf_token %}  {% csrf_token %}

    {% if user_form.non_field_errors %}

  {% if form.non_field_errors %}    <div class="alert alert-danger">

    <div class="alert alert-danger">      {{ user_form.non_field_errors }}

      {{ form.non_field_errors }}    </div>

    </div>  {% endif %}

  {% endif %}  <div class="row g-3">

      <div class="col-md-4">{{ user_form.username.label_tag }} {{ user_form.username }} {{ user_form.username.errors }}</div>

  <div class="row g-3">    <div class="col-md-4">{{ user_form.first_name.label_tag }} {{ user_form.first_name }} {{ user_form.first_name.errors }}</div>

    <div class="col-md-4">{{ form.username.label_tag }} {{ form.username }} {{ form.username.errors }}</div>    <div class="col-md-4">{{ user_form.last_name.label_tag }} {{ user_form.last_name }} {{ user_form.last_name.errors }}</div>

    <div class="col-md-4">{{ form.first_name.label_tag }} {{ form.first_name }} {{ form.first_name.errors }}</div>    <div class="col-md-6">{{ user_form.email.label_tag }} {{ user_form.email }} {{ user_form.email.errors }}</div>

    <div class="col-md-4">{{ form.last_name.label_tag }} {{ form.last_name }} {{ form.last_name.errors }}</div>    <div class="col-md-3">{{ user_form.dni.label_tag }} {{ user_form.dni }} {{ user_form.dni.errors }}</div>

    <div class="col-md-6">{{ form.email.label_tag }} {{ form.email }} {{ form.email.errors }}</div>    <div class="col-md-3">{{ user_form.phone.label_tag }} {{ user_form.phone }} {{ user_form.phone.errors }}</div>

    <div class="col-md-3">{{ form.dni.label_tag }} {{ form.dni }} {{ form.dni.errors }}</div>    <div class="col-md-4">{{ user_form.birth_date.label_tag }} {{ user_form.birth_date }} {{ user_form.birth_date.errors }}</div>

    <div class="col-md-3">{{ form.phone.label_tag }} {{ form.phone }} {{ form.phone.errors }}</div>    <div class="col-md-8">{{ user_form.address.label_tag }} {{ user_form.address }} {{ user_form.address.errors }}</div>

    <div class="col-md-4">{{ form.birth_date.label_tag }} {{ form.birth_date }} {{ form.birth_date.errors }}</div>    <div class="col-md-4">{{ user_form.role.label_tag }} {{ user_form.role }} {{ user_form.role.errors }}</div>

    <div class="col-md-8">{{ form.address.label_tag }} {{ form.address }} {{ form.address.errors }}</div>    <div class="col-md-4">{{ user_form.is_active.label_tag }} {{ user_form.is_active }} {{ user_form.is_active.errors }}</div>

    <div class="col-md-4">{{ form.role.label_tag }} {{ form.role }} {{ form.role.errors }}</div>

    <div class="col-md-4">{{ form.is_active.label_tag }} {{ form.is_active }} {{ form.is_active.errors }}</div>    {# Passwords appear when creating users (UserCreateForm extends UserBaseForm) #}

    {% if user_form.password1 %}

    {% if form.password1 %}      <div class="col-md-4">{{ user_form.password1.label_tag }} {{ user_form.password1 }} {{ user_form.password1.errors }}</div>

      <div class="col-md-4">{{ form.password1.label_tag }} {{ form.password1 }} {{ form.password1.errors }}</div>      <div class="col-md-4">{{ user_form.password2.label_tag }} {{ user_form.password2 }} {{ user_form.password2.errors }}</div>

      <div class="col-md-4">{{ form.password2.label_tag }} {{ form.password2 }} {{ form.password2.errors }}</div>    {% endif %}

    {% endif %}  </div>

  </div>

  <hr />

  {% if profile_form %}  <div class="row g-3">

    <hr />    <h5>Datos de Perfil</h5>

    <h5>Datos de Perfil</h5>    <div id="student-fields" style="display:none">

    <div class="row g-3">      {% for field in student_profile_form %}

      {% for field in profile_form %}        <div class="col-md-4">{{ field.label_tag }} {{ field }} {{ field.errors }}</div>

        <div class="col-md-4">{{ field.label_tag }} {{ field }} {{ field.errors }}</div>      {% endfor %}

      {% endfor %}    </div>

    </div>    <div id="professor-fields" style="display:none">

  {% endif %}      {% for field in professor_profile_form %}

        <div class="col-md-4">{{ field.label_tag }} {{ field }} {{ field.errors }}</div>

  <div class="mt-3">      {% endfor %}

    <button class="btn btn-primary">Guardar</button>    </div>

    <a class="btn btn-secondary" href="{% url 'app:user-list' %}">Volver</a>    <div id="admin-fields" style="display:none">

  </div>      {% for field in administrator_profile_form %}

</form>        <div class="col-md-4">{{ field.label_tag }} {{ field }} {{ field.errors }}</div>

{% endblock %}      {% endfor %}
    </div>
  </div>

  <div class="mt-3">
    <button class="btn btn-primary">Guardar</button>
    <a class="btn btn-secondary" href="{% url 'app:user-list' %}">Volver</a>
  </div>
</form>
<script>
  (function() {
    const roleSelect = document.getElementById('id_role');
    const student = document.getElementById('student-fields');
    const professor = document.getElementById('professor-fields');
    const admin = document.getElementById('admin-fields');

    function setDisabled(container, disabled) {
      if (!container) return;
      const inputs = container.querySelectorAll('input, select, textarea');
      inputs.forEach(el => { el.disabled = disabled; });
    }

    function showForRole(role) {
      // Hide all
      [student, professor, admin].forEach(c => { if (c) c.style.display = 'none'; });
      setDisabled(student, true); setDisabled(professor, true); setDisabled(admin, true);

      if (role === 'student') {
        if (student) student.style.display = '';
        setDisabled(student, false);
      } else if (role === 'professor') {
        if (professor) professor.style.display = '';
        setDisabled(professor, false);
      } else if (role === 'administrator') {
        if (admin) admin.style.display = '';
        setDisabled(admin, false);
      }
    }

    if (roleSelect) {
      roleSelect.addEventListener('change', (e) => showForRole(e.target.value));
      const initial = '{{ selected_role|default_if_none:"" }}' || roleSelect.value;
      showForRole(initial);
    }
  })();
</script>
{% endblock %}
